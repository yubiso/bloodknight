<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Missions - BloodKnight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-50 text-slate-800">

    <nav class="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 hover:scale-105 transition-all px-2 py-1 rounded-lg" onclick="window.location.href='dashboard.html'" title="Go to Dashboard">
            <i class="fas fa-shield-alt text-red-600 text-2xl"></i>
            <span class="text-xl font-bold uppercase tracking-tight">BloodKnight</span>
        </div>
        <a href="dashboard.html" class="text-sm font-medium text-slate-500 hover:text-red-600 transition-colors">
            <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
        </a>
    </nav>

    <div class="max-w-4xl mx-auto p-6">
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Find a Mission</h1>
            <p class="text-slate-500">Locate active blood drives nearby and secure your slot.</p>
        </div>

        <div id="restriction-banner" class="hidden mb-6 bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r shadow-sm flex items-start">
            <i class="fas fa-exclamation-triangle text-orange-500 mt-1 mr-3"></i>
            <div>
                <h3 class="font-bold text-orange-800">Mission Restrictions Active</h3>
                <p id="restriction-msg" class="text-sm text-orange-700">You currently have a restriction on your file.</p>
            </div>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-4 mb-8">
            <div class="flex-1 relative">
                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Search by location (e.g. 'Mall', 'Hospital')..." 
                       class="w-full pl-10 pr-4 py-3 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:border-red-200 focus:ring-2 focus:ring-red-100 outline-none transition-all">
            </div>
            <button onclick="fetchDrives()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-medium transition-colors">
                Search
            </button>
        </div>

        <div id="drivesList" class="grid gap-4">
            <div class="text-center py-10 text-slate-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading operations...</p>
            </div>
        </div>

    </div>

    <div id="bookingModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-900">Select Time Slot</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div id="slotsContainer" class="grid grid-cols-3 gap-3 max-h-80 overflow-y-auto p-1">
                </div>

            <div id="bookingMessage" class="mt-4 text-center text-sm font-bold"></div>
            
            <button id="confirmBookingBtn" disabled class="w-full bg-slate-400 text-white py-3 mt-4 rounded-xl font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Confirm Selected Slot
            </button>
        </div>
    </div>

    <script>
        let currentDriveId = null;
        let currentDriveName = "";
        let isRestricted = false;
        let restrictionReason = "";
        let selectedTimeSlot = null;
        let currentOrgName = ""; 
        let currentDriveDate = ""; 

        // --- 1. CHECK RESTRICTIONS ON LOAD ---
        function checkEligibility() {
            // Check Active Appointment (1 Max)
            const activeAppt = localStorage.getItem('bk_active_appt');
            if (activeAppt) {
                isRestricted = true;
                restrictionReason = "Active Mission Pending";
                showRestriction("You already have a booked mission. Complete or cancel it before booking another.");
                return;
            }

            // Check Donation Cooldown (90 Days)
            const lastDonation = localStorage.getItem('bk_last_donation');
            if (lastDonation) {
                const lastDate = new Date(lastDonation);
                const nextDate = new Date(lastDate);
                nextDate.setDate(nextDate.getDate() + 90); // 90 DAYS RULE
                
                if (new Date() < nextDate) {
                    isRestricted = true;
                    restrictionReason = "Medical Cooldown";
                    showRestriction("You are currently in the recovery period. Please wait for the countdown on your dashboard.");
                }
            }
        }

        function showRestriction(msg) {
            document.getElementById('restriction-banner').classList.remove('hidden');
            document.getElementById('restriction-msg').innerText = msg;
        }

        async function fetchDrives() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const container = document.getElementById('drivesList');
            container.innerHTML = '<div class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Scanning network...</p></div>';
            
            let drivesData = [];
            try {
                const response = await fetch(`bloodknight.php?action=get_drives&query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error("Backend offline");
                const result = await response.json();
                if (result.status === 'success') drivesData = result.data;
                else throw new Error("API Error");
            } catch (error) {
                // Display error instead of mock data
                container.innerHTML = `<div class="text-center py-10 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Error: Could not connect to mission database.</p></div>`;
                return;
            }
            renderDrives(drivesData);
        }

        function renderDrives(drives) {
            const container = document.getElementById('drivesList');
            container.innerHTML = '';

            if (drives.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400">No missions found matching your criteria.</div>`;
                return;
            }

            drives.forEach(drive => {
                const dateObj = new Date(drive.drive_date);
                const dateNum = dateObj.getDate();
                const month = dateObj.toLocaleString('default', { month: 'short' });

                let buttonHTML = '';
                if (isRestricted) {
                    // Display locked button if any restriction is active
                    buttonHTML = `
                        <button disabled class="bg-slate-100 text-slate-400 px-6 py-3 rounded-xl font-medium text-sm border border-slate-200 cursor-not-allowed flex items-center gap-2">
                            <i class="fas fa-lock"></i> ${restrictionReason}
                        </button>`;
                } else {
                    buttonHTML = `
                        <button onclick="openBookingModal(${drive.drive_id}, '${drive.location_name}', '${drive.organization_name || 'Medical Facility'}', '${drive.drive_date}')" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-medium text-sm hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                            View Slots
                        </button>`;
                }

                const card = `
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-start gap-4">
                            <div class="w-16 h-16 bg-red-50 text-red-600 rounded-2xl flex items-center justify-center flex-shrink-0 text-xl font-bold flex-col leading-none">
                                <span>${dateNum}</span>
                                <span class="text-[10px] uppercase mt-1">${month}</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-slate-900">${drive.location_name}</h3>
                                <p class="text-slate-500 text-sm mb-1"><i class="fas fa-building mr-1"></i> ${drive.organization_name || 'Medical Facility'}</p>
                                <div class="flex gap-4 text-xs font-medium text-slate-400 mt-2">
                                    <span class="bg-slate-100 px-2 py-1 rounded"><i class="far fa-clock mr-1"></i> ${drive.start_time.slice(0,5)} - ${drive.end_time.slice(0,5)}</span>
                                </div>
                            </div>
                        </div>
                        ${buttonHTML}
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function openBookingModal(driveId, driveName, orgName, driveDate) {
            currentDriveId = driveId;
            currentDriveName = driveName;
            currentOrgName = orgName;
            currentDriveDate = driveDate;
            selectedTimeSlot = null;

            const modal = document.getElementById('bookingModal');
            const container = document.getElementById('slotsContainer');
            const msg = document.getElementById('bookingMessage');
            const confirmBtn = document.getElementById('confirmBookingBtn');
            
            confirmBtn.disabled = true;
            confirmBtn.onclick = handleBookingConfirmation;
            confirmBtn.innerHTML = 'Confirm Selected Slot';
            confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            confirmBtn.classList.add('bg-slate-400');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            container.innerHTML = '<div class="col-span-3 text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading availability...</div>';
            msg.innerText = '';

            // Fetch real slots
            fetch(`bloodknight.php?action=get_slots&drive_id=${driveId}`)
                .then(res => res.json())
                .then(res => {
                    if(res.status === 'success') renderSlots(res.data);
                    else container.innerHTML = `<p class="col-span-3 text-red-500 text-center">${res.message}</p>`;
                })
                .catch(err => {
                    container.innerHTML = `<p class="col-span-3 text-red-500 text-center"><i class="fas fa-exclamation-triangle mr-1"></i> Failed to retrieve live slots.</p>`;
                });
        }

        function selectSlot(time, displayTime, btnElement) {
            const allButtons = document.querySelectorAll('#slotsContainer button');
            const confirmBtn = document.getElementById('confirmBookingBtn');
            const msg = document.getElementById('bookingMessage');
            
            // 1. Clear previous selection highlight
            allButtons.forEach(btn => {
                if (!btn.disabled) {
                    btn.classList.remove('bg-red-600', 'text-white', 'border-red-600', 'hover:bg-red-600');
                    btn.classList.add('bg-white', 'text-slate-700', 'border-slate-200', 'hover:bg-red-50');
                }
            });

            // 2. Set new selection highlight
            btnElement.classList.remove('bg-white', 'text-slate-700', 'border-slate-200', 'hover:bg-red-50');
            btnElement.classList.add('bg-red-600', 'text-white', 'border-red-600', 'hover:bg-red-600');
            
            selectedTimeSlot = { raw: time, display: displayTime, element: btnElement };
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('bg-slate-400');
            confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            confirmBtn.innerHTML = `Confirm ${displayTime} Slot`;
            msg.innerText = '';
        }

        function renderSlots(slots) {
            const container = document.getElementById('slotsContainer');
            container.innerHTML = '';

            // Get current date/time for comparison
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0]; // YYYY-MM-DD format
            const currentTime = now.toTimeString().split(' ')[0]; // HH:MM:SS format

            slots.forEach(slot => {
                const btn = document.createElement('button');
                btn.classList.add("py-2", "px-1", "rounded-lg", "text-sm", "font-semibold", "transition-all", "border", "hover:border-red-500");
                
                // Check if slot is in the past
                const isPast = currentDriveDate && (
                    currentDriveDate < currentDate || 
                    (currentDriveDate === currentDate && slot.raw_time < currentTime)
                );
                
                if (slot.is_taken) {
                    btn.classList.add("bg-slate-100", "text-slate-400", "border-transparent", "cursor-not-allowed");
                    btn.innerHTML = `${slot.display_time}<br><span class='text-[10px] uppercase'>Taken</span>`;
                    btn.disabled = true;
                } else if (isPast) {
                    // Slot is in the past - make it unavailable
                    btn.classList.add("bg-slate-100", "text-slate-400", "border-transparent", "cursor-not-allowed");
                    btn.innerHTML = `${slot.display_time}<br><span class='text-[10px] uppercase'>Past</span>`;
                    btn.disabled = true;
                } else {
                    // Initial state for available slots
                    btn.classList.add("bg-white", "border-slate-200", "text-slate-700", "hover:bg-red-50");
                    btn.innerHTML = `${slot.display_time}<br><span class='text-[10px] text-green-500 uppercase'>Available</span>`;
                    btn.onclick = () => selectSlot(slot.raw_time, slot.display_time, btn); // Call selectSlot
                }
                container.appendChild(btn);
            });
        }
        
        function handleBookingConfirmation() {
            if (!selectedTimeSlot) return; 

            const confirmBtn = document.getElementById('confirmBookingBtn');
            const msg = document.getElementById('bookingMessage');
            
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Booking...';
            
            const formData = new FormData();
            formData.append('action', 'book_appointment');
            formData.append('drive_id', currentDriveId);
            formData.append('time', selectedTimeSlot.raw);

            fetch('bloodknight.php', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    // CRUCIAL: Update local storage on real success
                    const fakeAppt = {
                        appt_id: res.appt_id || Math.floor(Math.random() * 9000), 
                        location_name: currentDriveName,
                        hospital_name: currentOrgName,
                        drive_date: currentDriveDate,
                        selected_time: selectedTimeSlot.display,
                        status: 'Pending'
                    };
                    localStorage.setItem('bk_active_appt', JSON.stringify(fakeAppt));
                    
                    successBooking(msg, selectedTimeSlot.display);
                } else {
                    msg.className = "mt-4 text-center text-sm font-bold text-red-600";
                    msg.innerText = res.message;
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = `Confirm ${selectedTimeSlot.display} Slot`;
                }
            })
            .catch(err => {
                msg.className = "mt-4 text-center text-sm font-bold text-red-600";
                msg.innerText = "Error: Could not connect to booking service. Please check server.";
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = `Confirm ${selectedTimeSlot.display} Slot`;
            });
        }

        function successBooking(msgElement, displayTime) {
            msgElement.className = "mt-4 text-center text-sm font-bold text-green-600";
            msgElement.innerText = `Slot ${displayTime} Confirmed! Redirecting...`;
            setTimeout(() => window.location.href = 'dashboard.html', 1000);
        }

        function closeModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            document.getElementById('bookingModal').classList.remove('flex');
            selectedTimeSlot = null; // Clear state on close
        }

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('bloodknight.php?action=check_session');
                const result = await response.json();
                if (result.status !== 'success') {
                    localStorage.removeItem('bk_user_profile');
                    localStorage.removeItem('bk_last_donation');
                    localStorage.removeItem('bk_active_appt');
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                const savedProfile = localStorage.getItem('bk_user_profile');
                if (!savedProfile) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                checkEligibility();
                fetchDrives();
            }
        });
    </script>
</body>
</html>
